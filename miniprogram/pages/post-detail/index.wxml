<!-- pages/post-detail/index.wxml -->
<import src="../../templates/forum-templates.wxml" />

<view class="detail-container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="detail-header">
    <view class="back-btn" bindtap="navigateBack">
      <text class="back-icon">â†</text>
    </view>
    <view class="header-title">å¸–å­è¯¦æƒ…</view>
    <button class="share-btn" open-type="share">
      <text class="share-icon">ğŸ”—</text>
    </button>
  </view>
  
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="weui-loading"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
  
  <!-- å¸–å­è¯¦æƒ… -->
  <block wx:elif="{{postDetail}}">
    <scroll-view 
      class="detail-scroll" 
      scroll-y="true" 
      enable-back-to-top="true"
      bindscrolltolower="onReachBottom">
      
      <!-- å¸–å­å†…å®¹åŒº -->
      <view class="post-detail">
        <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
        <view class="detail-user-info">
          <image class="detail-avatar" src="{{postDetail.author.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="detail-user-name-time">
            <view class="detail-user-name">{{postDetail.author.nickName || 'åŒ¿åç”¨æˆ·'}}</view>
            <view class="detail-post-time">{{postDetail.createTime}}</view>
          </view>
          <view class="post-category" wx:if="{{postDetail.category}}">
            <text class="category-text">{{postDetail.categoryName || postDetail.category}}</text>
          </view>
        </view>
        
        <!-- å¸–å­å†…å®¹åŒº -->
        <view class="detail-content">
          <view class="detail-title">{{postDetail.title}}</view>
          <view class="detail-text">{{postDetail.content}}</view>
          
          <!-- å›¾ç‰‡åŒºåŸŸ -->
          <view class="detail-images" wx:if="{{postDetail.images && postDetail.images.length > 0}}">
            <block wx:for="{{postDetail.images}}" wx:key="*this">
              <image 
                class="detail-image" 
                src="{{item}}" 
                mode="widthFix" 
                bindtap="previewImage" 
                data-src="{{item}}" 
                data-urls="{{postDetail.images}}"
              ></image>
            </block>
          </view>
        </view>
        
        <!-- äº’åŠ¨åŒºåŸŸ -->
        <view class="detail-interaction">
          <view class="detail-interaction-item {{postDetail.isLiked ? 'liked' : ''}}" bindtap="toggleLike">
            <text class="detail-interaction-icon {{postDetail.isLiked ? 'active' : ''}}">{{postDetail.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            <text class="detail-interaction-count">{{postDetail.likes || 0}}</text>
          </view>
          <view class="detail-interaction-item" bindtap="focusCommentInput">
            <text class="detail-interaction-icon">ğŸ’¬</text>
            <text class="detail-interaction-count">{{postDetail.comments || 0}}</text>
          </view>
          <view class="detail-interaction-item {{postDetail.isCollected ? 'collected' : ''}}" bindtap="toggleCollect">
            <text class="detail-interaction-icon {{postDetail.isCollected ? 'collected' : ''}}">{{postDetail.isCollected ? 'â­' : 'â˜†'}}</text>
          </view>
          <button class="detail-share-btn" open-type="share">
            <text class="detail-interaction-icon">ğŸ”—</text>
          </button>
        </view>
      </view>
      
      <!-- è¯„è®ºåŒº -->
      <view class="comment-section">
        <view class="comment-header">
          <text class="comment-title">è¯„è®º ({{postDetail.comments || 0}})</text>
        </view>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <block wx:if="{{commentList.length > 0}}">
          <comment-item 
            wx:for="{{commentList}}" 
            wx:key="_id" 
            comment="{{item}}" 
            bind:tapcomment="replyComment"
          />
        </block>
        
        <!-- ç©ºè¯„è®ºçŠ¶æ€ -->
        <view wx:elif="{{!loadingComments}}" class="empty-comment">
          <text class="empty-icon">ğŸ’¬</text>
          <view class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§~</view>
        </view>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{loadingComments}}" class="loading-state">
          <view class="weui-loading"></view>
          <view class="loading-text">åŠ è½½ä¸­...</view>
        </view>
        
        <!-- åŠ è½½å®Œæ¯•æç¤º -->
        <view wx:if="{{!hasMoreComments && commentList.length > 0}}" class="loading-end">
          - å·²ç»åˆ°åº•å•¦ -
        </view>
      </view>
    </scroll-view>
    
    <!-- è¯„è®ºè¾“å…¥æ¡† -->
    <view class="comment-input-container">
      <view class="comment-input-box">
        <input 
          class="comment-input" 
          placeholder="{{replyTo ? 'å›å¤ @' + replyTo.author.nickName : 'è¯´ç‚¹ä»€ä¹ˆå§...'}}" 
          placeholder-class="placeholder" 
          maxlength="{{commentMaxLength}}" 
          value="{{commentContent}}" 
          bindinput="onInputComment"
          focus="{{commentFocus}}"
          confirm-type="send"
          bindconfirm="submitComment"
        />
        <view class="comment-counter">{{commentContent.length}}/{{commentMaxLength}}</view>
      </view>
      <view class="comment-submit-btn {{!commentContent.trim() || submittingComment ? 'disabled' : ''}}" bindtap="submitComment">å‘é€</view>
    </view>
  </block>
  
  <!-- å¸–å­ä¸å­˜åœ¨ -->
  <view class="not-found" wx:else>
    <text class="not-found-icon">âš ï¸</text>
    <view class="not-found-text">å¸–å­ä¸å­˜åœ¨æˆ–å·²åˆ é™¤</view>
    <view class="back-home-btn" bindtap="navigateBack">è¿”å›</view>
  </view>
</view>